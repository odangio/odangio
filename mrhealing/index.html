<header>
<script src="https://unpkg.com/vue@2.1.10/dist/vue.js">
</script>
</header>
<div id="branch-list">
    <button v-on:click="located">위치 재확인</button> <div class="loading">{{ loading }}</div>
    <ul>
        <li class="click" v-for="(data, index ) in response" v-on:click="selectBranch" v-if="data.distance >= -1" >
          {{data.title}}
          <span v-if="data.distance <= -1" class="distance loading">계산중..</span>
          <span v-else-if="data.distance <= 10" class="distance good">{{ data.distance }}km</span>
          <span v-if="data.distance  > 10" class="distance farfar">지역초과</span>
        </li>
    </ul>
</div>

<style>
.loading{
  padding: 5px;
  font-size: 0.9em;
  color: #ccc;
}
ul{
  padding-left: 0px;
  margin: 0px;
}
.distance.good{ color: blue}
.distance.farfar{ color: #ccc}
.distance.loading{ color: yellow}
ul li.click:first-child {
  font-weight: bold;
}
.click{
  cursor: pointer;
  border: 1px solid blue;
  padding: 3px;
  display: inline-block;
  margin: 3px;
  border-radius: 2px;
  background-color: #eee;
}
.click:hover{
  background-color: #ddd;
}
</style>
<script type="text/javascript">
  window.onload=function(){
    //위치정보를 확인할 수 있는 브라우저인지 확인
    if(navigator.geolocation == undefined){
        alert("위치 정보 기능을 지원하지 않습니다!")
        return;
    }
 }


var apiUrl = 'http://ajinbooking.startupsite.in/wp-admin/admin-ajax.php?action=list_brandbranch_info&brand=%EB%AF%B8%EC%8A%A4%ED%84%B0%ED%9E%90%EB%A7%81'
//apiUrl = 'https://odengio.github.io/odengio/mrhealing/admin-ajax.js';
var branchList = new Vue({
    el: '#branch-list',
    data: {response : [],lat : 0,lon : 0 ,loading :"" },
    created: function (){
        this.located();
        this.fetchData();
    },
    methods: {
        located(){
            console.log('selectBranch');
            this.response.forEach(function (item) {
              item.distance = -1;
            })
            this.showData();
            this.resort();

        },
        selectBranch(){
            console.log('selectBranch');
        },
        //현재 위치 정보 알아보는 메소드
        showData(){
            this.loading = "위치 확인중....";
            navigator.geolocation.getCurrentPosition(this.success, this.fail);
            //현재 위치 정보를 조사하고 성공 실패 했을시 호출되는 함수 설정
        },
        success(position) { //성공시

            this.log("위치정보 확인 성공!");
            for(var property in position.coords) { //반복문 돌면서 출력
                this.log("Key 값:"+property+" 정보:"+position.coords[property]);
            }
            this.lat=position.coords["latitude"];
            this.lon=position.coords["longitude"];
            var url="http://maps.googleapis.com/maps/api/geocode/json?latlng="+this.lat+","+this.lon+"&sensor=false";
             //location.href = url;//페이지 이동하기
            this.resort(position.coords["latitude"] , position.coords["longitude"]);
            console.log('resort');            this.loading = "계산완료";

         },
         //실패시
          fail(err){
            switch (err.code){
                case err.PERMISSION_DENIED:
                    msg = "사용자 거부";
                break;

                case err.PERMISSION_UNAVAILABLE:
                    msg = "지리정보를 얻을 수 없음";
                break;

                case err.TIMEOUT:
                    msg = "시간초과";
                break;

                case err.UNKNOWN_ERROR:
                    msg = "알 수 없는 오류 발생";
                break;
            }
                this.log(msg);
         },
        log(msg){
            console.log(msg);

         },
        jsonp(src, options) {
            var callback_name = options.callbackName || 'callback',
              on_success = options.onSuccess || function(){},
              on_timeout = options.onTimeout || function(){},
              timeout = options.timeout || 10; // sec

            var timeout_trigger = window.setTimeout(function(){
              window[callback_name] = function(){};
              on_timeout();
            }, timeout * 1000);

            window[callback_name] = function(data){
              window.clearTimeout(timeout_trigger);
              on_success(data);
            }

            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.src = src;

            document.getElementsByTagName('head')[0].appendChild(script);
          },
        resort: function(lat1, lon1){
          function distance(lat1, lon1, lat2, lon2, unit) {
             var radlat1 = Math.PI * lat1/180
             var radlat2 = Math.PI * lat2/180
             var theta = lon1-lon2
             var radtheta = Math.PI * theta/180
             var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
             dist = Math.acos(dist)
             dist = dist * 180/Math.PI
             dist = dist * 60 * 1.1515
             if (unit=="K") { dist = dist * 1.609344 }
             if (unit=="N") { dist = dist * 0.8684 }
             return dist
          }
          this.response.forEach(function (item) {

            var lat2 = item.latitude;
            var lon2 = item.longitude;
            var unit = "K";
            item.distance = parseInt(distance(lat1, lon1, lat2, lon2, unit) * 10) /10;
          })
          this.response.sort(function(a,b){
              return ( a.distance < b.distance) ? -1 : ( a.distance > b.distance) ? 1 : 0;
          });
          if(this.response.length > 5){
            this.response = this.response.slice(0,5);
            this.msg = "가장 가까운 5개 지점만 표시합니다. ";
            this.loading = "계산완료";
          }

          console.log('계산완료');
        },
        fetchData: function () {
            this.jsonp(apiUrl, {
              callbackName: 'callback',
              onSuccess: function(json){
                  this.response = json.data
                  console.log('success!',   this.response);
              }.bind(this),
              onTimeout: function(){
                  console.log('timeout!');
              },
              timeout: 5
            });
        }
    }
})
</script>
